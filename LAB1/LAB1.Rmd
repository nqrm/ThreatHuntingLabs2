---
title: ""
output: md_document
date: "2023-03-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Подключение нужных пакетов

```{r,warning=FALSE, message=FALSE, error=FALSE}
library(arrow)
library(dplyr)
library(stringr)
library(lubridate)
library(ggplot2)
```

### Импорт датасета

```{r,warning=FALSE, message=FALSE, error=FALSE}
dataset <- arrow::read_csv_arrow("gowiththeflow_20190826.csv",schema = schema(timestamp=int64(),src=utf8(),dst=utf8(),port=uint32(),bytes=uint32())) %>% collect()
```

# Задание 1: Найдите утечку данных из Вашей сети

## Важнейшие документы с результатами нашей исследовательской деятельности в области создания вакцин скачиваются в виде больших заархивированных дампов. Один из хостов в нашей сети используется для пересылки этой информации -- он пересылает гораздо больше информации на внешние ресурсы в Интернете, чем остальные компьютеры нашей сети. Определите его IP-адрес.

### Определение IP-адреса, который пересылает больше информации на внешние ресурсы.

### Ответ на задание - 13.37.84.125

```{r,warning=FALSE, message =FALSE, error=FALSE}
dataset %>%
  select(src,dst,bytes) %>%
  mutate(outside_traffic = str_detect(src,"^((12|13|14)\\.)") & !str_detect(dst,"^((12|13|14)\\.)")) %>%
  filter(outside_traffic == TRUE) %>%
  group_by(src) %>%
  summarise(total_bytes = sum(bytes)) %>%
  arrange(desc(total_bytes)) %>%
  head(1) %>%
  collect()
```

# Задание 2: Надите утечку данных 2

## Другой атакующий установил автоматическую задачу в системном планировщике cron для экспорта содержимого внутренней wiki системы. Эта система генерирует большое количество траффика в нерабочие часы, больше чем остальные хосты. Определите IP этой системы. Известно, что ее IP адрес отличается от нарушителя из предыдущей задачи.

### Топ 10 ip-адресов, генерирующих большое количество трафика в нерабочее время

### Построя графики распределения количества пакетов и данных за каждый час, можно предположить, что часы с меньшей активностью и есть нерабочие - с 0 по 15.

### Ответ на задание - 12.55.77.96

```{r, warning=FALSE, message=FALSE, error=FALSE}
dataset %>%
  select(timestamp, src, dst, bytes) %>%
  mutate(outside_traffic = (str_detect(src,"^((12|13|14)\\.)") & !str_detect(dst,"^((12|13|14)\\.)")), hour = hour(as_datetime(timestamp/1000))) %>%
  filter(outside_traffic == TRUE, hour >= 0 & hour <= 15) %>%
  group_by(src) %>%
  summarise(total_bytes = sum(bytes)) %>%
  arrange(desc(total_bytes))  %>%
  head(10) %>%
  collect()
  
  # График распределения отправленных пакетов в каждый час
  #group_by(hour) %>%
  #summarise(packets=n()) %>%
  #collect()
  #ggplot(., aes(x=hour,y=packets),) + geom_histogram(stat="identity", color="black",fill="green")
```
