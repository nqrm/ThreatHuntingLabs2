### Подключение нужных пакетов

    library(arrow)
    library(dplyr)
    library(stringr)
    library(lubridate)
    library(ggplot2)

### Импорт датасета

    dataset <- arrow::read_csv_arrow("gowiththeflow_20190826.csv",schema = schema(timestamp=int64(),src=utf8(),dst=utf8(),port=uint32(),bytes=uint32())) %>% collect()

# Задание 1: Найдите утечку данных из Вашей сети

## Важнейшие документы с результатами нашей исследовательской деятельности в области создания вакцин скачиваются в виде больших заархивированных дампов. Один из хостов в нашей сети используется для пересылки этой информации – он пересылает гораздо больше информации на внешние ресурсы в Интернете, чем остальные компьютеры нашей сети. Определите его IP-адрес.

### Определение IP-адреса, который пересылает больше информации на внешние ресурсы.

### Ответ на задание - 13.37.84.125

    dataset %>%
      select(src,dst,bytes) %>%
      mutate(outside_traffic = str_detect(src,"^((12|13|14)\\.)") & !str_detect(dst,"^((12|13|14)\\.)")) %>%
      filter(outside_traffic == TRUE) %>%
      group_by(src) %>%
      summarise(total_bytes = sum(bytes)) %>%
      arrange(desc(total_bytes)) %>%
      head(1) %>%
      collect()

    ## # A tibble: 1 × 2
    ##   src          total_bytes
    ##   <chr>              <dbl>
    ## 1 13.37.84.125 10625497574

# Задание 2: Надите утечку данных 2

## Другой атакующий установил автоматическую задачу в системном планировщике cron для экспорта содержимого внутренней wiki системы. Эта система генерирует большое количество траффика в нерабочие часы, больше чем остальные хосты. Определите IP этой системы. Известно, что ее IP адрес отличается от нарушителя из предыдущей задачи.

### Топ 2 ip-адреса, генерирующих большое количество трафика в нерабочее время

### Построя графики распределения количества пакетов и данных за каждый час, можно предположить, что часы с меньшей активностью и есть нерабочие - с 0 по 15.

### Ответ на задание - 12.55.77.96

    dataset %>%
      select(timestamp, src, dst, bytes) %>%
      mutate(outside_traffic = (str_detect(src,"^((12|13|14)\\.)") & !str_detect(dst,"^((12|13|14)\\.)")), hour = hour(as_datetime(timestamp/1000))) %>%
      filter(outside_traffic == TRUE, hour >= 0 & hour <= 15) %>%
      group_by(src) %>%
      summarise(total_bytes = sum(bytes)) %>%
      arrange(desc(total_bytes))  %>%
      head(10) %>%
      collect()

    ## # A tibble: 10 × 2
    ##    src          total_bytes
    ##    <chr>              <int>
    ##  1 13.37.84.125   731158032
    ##  2 12.55.77.96    289566918
    ##  3 13.48.72.30    120862595
    ##  4 14.51.30.86    116752466
    ##  5 12.59.25.34    115533918
    ##  6 14.51.75.107   112816919
    ##  7 12.56.32.111   111708846
    ##  8 12.58.68.102   108870195
    ##  9 14.57.50.29    108788348
    ## 10 13.39.46.94    107736632

      # График распределения отправленных пакетов в каждый час
      #group_by(hour) %>%
      #summarise(packets=n()) %>%
      #collect()
      #ggplot(., aes(x=hour,y=packets),) + geom_histogram(stat="identity", color="black",fill="green")
